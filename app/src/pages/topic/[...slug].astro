---
import Layout from '../../layouts/Layout.astro';
import topicsData from '../../data/topics.json';
import path from 'path';
import fs from 'fs';
import { marked } from 'marked';
export function getStaticPaths() {
  const paths: { params: { slug: string }; props: Record<string, unknown> }[] = [];
  for (const cat of topicsData.categories) {
    for (const t of cat.topics) {
      paths.push({
        params: { slug: `${cat.id}/${t.slug}` },
        props: {
          categoryId: cat.id,
          categoryLabel: cat.label,
          slug: t.slug,
          title: t.title,
        },
      });
    }
  }
  return paths;
}

const { categoryId, categoryLabel, slug, title } = Astro.props;
const glossaryRoot = path.join(process.cwd(), '..');
const mdPath = path.join(glossaryRoot, categoryId, `${slug}.md`);
let rawMd = '';
try {
  rawMd = fs.readFileSync(mdPath, 'utf-8');
} catch {
  rawMd = '# ' + title + '\n\nContent not found.';
}
const html = await marked.parse(rawMd);

// Prev/next in same category
const cat = topicsData.categories.find((c) => c.id === categoryId);
const topicIndex = cat?.topics.findIndex((t) => t.slug === slug) ?? -1;
const prevTopic = topicIndex > 0 && cat ? cat.topics[topicIndex - 1] : null;
const nextTopic = topicIndex >= 0 && cat && topicIndex < cat.topics.length - 1 ? cat.topics[topicIndex + 1] : null;
---

<Layout title={title} currentCategory={categoryId} currentSlug={slug}>
  <div class="breadcrumb">
    <a href="/">Glossary</a> &rarr; <a href={`/category/${categoryId}`}>{categoryLabel}</a> &rarr; {title}
  </div>
  <h1>{title}</h1>
  <div class="actions">
    <button type="button" class="btn" onclick="window.print()">Print / Save as PDF</button>
    <a class="btn" href={`/content/${categoryId}/${slug}.md`} download={`${slug}.md`}>Download as Markdown</a>
  </div>
  <article class="prose" set:html={html} />
  <nav class="nav-adjacent">
    {prevTopic ? (
      <a href={`/topic/${categoryId}/${prevTopic.slug}`}>&larr; {prevTopic.title}</a>
    ) : (
      <span />
    )}
    {nextTopic ? (
      <a href={`/topic/${categoryId}/${nextTopic.slug}`}>{nextTopic.title} &rarr;</a>
    ) : (
      <span />
    )}
  </nav>
</Layout>
