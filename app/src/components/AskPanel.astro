---
/**
 * Search the glossary: button + slide-in panel.
 * Uses client-side search over public/search-index.json (no API key).
 */
---
<div id="ask-panel-root" class="ask-panel-root">
  <button type="button" id="ask-panel-toggle" class="btn ask-panel-toggle" aria-expanded="false" aria-controls="ask-panel">
    Search the glossary
  </button>
  <aside id="ask-panel" class="ask-panel" role="dialog" aria-label="Search the glossary" hidden>
    <div class="ask-panel-header">
      <h2 class="ask-panel-title">Search the glossary</h2>
      <button type="button" id="ask-panel-close" class="ask-panel-close" aria-label="Close">&times;</button>
    </div>
    <form id="ask-panel-form" class="ask-panel-form">
      <label for="ask-question" class="ask-panel-label">Keywords</label>
      <textarea id="ask-question" name="question" rows="2" placeholder="e.g. git merge, data quality, schema" class="ask-panel-textarea"></textarea>
      <button type="submit" id="ask-submit" class="btn ask-panel-submit">Search</button>
    </form>
    <div id="ask-results-wrap" class="ask-answer-wrap" hidden>
      <div class="ask-answer-label">Matching topics</div>
      <ul id="ask-results" class="ask-results-list"></ul>
    </div>
    <div id="ask-error" class="ask-error" hidden></div>
    <div id="ask-loading" class="ask-loading" hidden>Searching...</div>
  </aside>
</div>

<script>
  (function () {
    const toggle = document.getElementById('ask-panel-toggle');
    const panel = document.getElementById('ask-panel');
    const closeBtn = document.getElementById('ask-panel-close');
    const form = document.getElementById('ask-panel-form');
    const questionEl = document.getElementById('ask-question');
    const resultsWrap = document.getElementById('ask-results-wrap');
    const resultsList = document.getElementById('ask-results');
    const errorEl = document.getElementById('ask-error');
    const loadingEl = document.getElementById('ask-loading');

    let searchIndexPromise = null;
    function getSearchIndex() {
      if (!searchIndexPromise) searchIndexPromise = fetch('/search-index.json').then((r) => { if (!r.ok) throw new Error('Failed to load'); return r.json(); });
      return searchIndexPromise;
    }

    function getSnippet(text, words, maxLen = 160) {
      if (!text) return '';
      const lower = text.toLowerCase();
      let bestStart = 0;
      let bestLen = 0;
      for (const w of words) {
        const i = lower.indexOf(w.toLowerCase());
        if (i === -1) continue;
        const start = Math.max(0, i - Math.floor(maxLen / 2));
        const end = Math.min(text.length, start + maxLen);
        if (end - start > bestLen) {
          bestStart = start;
          bestLen = end - start;
        }
      }
      if (bestLen === 0) return text.slice(0, maxLen);
      let snippet = text.slice(bestStart, bestStart + bestLen);
      if (bestStart > 0) snippet = '…' + snippet;
      if (bestStart + bestLen < text.length) snippet = snippet + '…';
      return snippet;
    }

    function openPanel() {
      panel.removeAttribute('hidden');
      toggle.setAttribute('aria-expanded', 'true');
      questionEl.focus();
    }

    function closePanel() {
      panel.setAttribute('hidden', '');
      toggle.setAttribute('aria-expanded', 'false');
    }

    toggle?.addEventListener('click', openPanel);
    closeBtn?.addEventListener('click', closePanel);

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const query = questionEl?.value?.trim();
      if (!query) return;

      resultsWrap?.setAttribute('hidden', '');
      errorEl?.setAttribute('hidden', '');
      if (errorEl) errorEl.textContent = '';
      if (resultsList) resultsList.innerHTML = '';
      loadingEl?.removeAttribute('hidden');

      try {
        const index = await getSearchIndex();
        const words = query.split(/\s+/).filter(Boolean);
        const scored = index.map((entry) => {
          const searchable = (entry.title + ' ' + (entry.text || '')).toLowerCase();
          const score = words.reduce((s, w) => s + (searchable.includes(w.toLowerCase()) ? 1 : 0), 0);
          return { ...entry, score };
        }).filter((r) => r.score > 0);
        scored.sort((a, b) => b.score - a.score);
        const top = scored.slice(0, 10);

        loadingEl?.setAttribute('hidden', '');
        if (resultsList) {
          if (top.length === 0) {
            resultsList.innerHTML = '<li class="ask-results-none">No topics match those keywords. Try different words.</li>';
          } else {
            resultsList.innerHTML = top.map((entry) => {
              const href = `/topic/${entry.categoryId}/${entry.slug}`;
              const snippet = getSnippet(entry.text, words);
              const safeTitle = entry.title.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
              const safeSnippet = snippet.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
              return `<li><a href="${href}">${safeTitle}</a> <span class="ask-results-cat">${(entry.categoryLabel || entry.categoryId).replace(/&/g, '&amp;').replace(/</g, '&lt;')}</span>${safeSnippet ? ` — ${safeSnippet}` : ''}</li>`;
            }).join('');
          }
          resultsWrap?.removeAttribute('hidden');
        }
      } catch (err) {
        loadingEl?.setAttribute('hidden', '');
        errorEl.textContent = 'Could not load search index. Try again.';
        errorEl.removeAttribute('hidden');
      }
    });
  })();
</script>
